\chapter{The Body Surface Potential}

Whilst modelling the heart itself can provide valuable insights into the effects
of diseases and inherited conditions, as Chapters 2 and 3 show, a clinical
doctor cannot look at the heart's activity directly without a surgical
procedure.
Instead they must rely on external tools such as the echocardiogram and the
electro-cardiogram (ECG).
To reproduce the ECG with mathematical models, it is necessary to solve what is known as
the ``forward problem''.


\section{The Forward Problem}

To solve the forward problem, Maxwell's equations must be solved to determine the
field in the torso which arises from currents flowing within the heart.
Due to the nature of the problem---the finite size of the torso and the
relatively low frequencies involved---simplifying assumptions can be made.
The effects of propagation and of capacitive and inductive currents may be
neglected~\cite{Barnard1966}.
The situation must solve therefore becomes a quasi-static volume conductor
problem, which involves only tissue conductances.
The current flow in the torso, $\mathbf{J}$, is given by Ohm's law
\begin{equation}
\label{eqn:bsp:ohm}
\mathbf{J} = \sigma\mathbf{E} + \mathbf{J}^{i}
\end{equation}
where $\mathbf{E}$ is the electric field, $\sigma$ is the tissue conductivity
and $\mathbf{J}^{i}$ is an impressed, or applied, current.
The applied current term is included to allow for the presence of active sources and
is non-zero only at the locations of active sources, i.e. the heart.
Since the total current in (\ref{eqn:bsp:ohm}) is solenoidal (the net flow into or
out of any closed region is zero),
\begin{equation}
\label{eqn:bsp:ohm2}
\nabla \cdot \mathbf{J} = 0 = \sigma \nabla \cdot \mathbf{E} + \nabla \cdot \mathbf{J}^{i}
%= 0 = \sigma \bigtriangledown \cdot \mathbf{E} +
%    \bigtriangledown \cdot \mathbf{J}^{i}
\end{equation}
must be true.
As we are solving the quasi-static problem, $\mathbf{E}$ can be
found simply from the gradient of the scalar potential, $\phi$, as
\begin{equation}
\label{eqn:bsp:maxwell}
\mathbf{E} = - \nabla\phi
\end{equation}

If (\ref{eqn:bsp:maxwell}) is substituted into (\ref{eqn:bsp:ohm2}) then we obtain
\begin{equation}
\label{eqn:bsp:poisson}
\nabla^{2}\phi = \frac{\nabla \cdot \mathbf{J}^{i}}{\sigma}
\end{equation}
which can be recognised as Poisson's equation.
In an infinite homogeneous conducting medium, a solution to Poisson's equation
for the field at any given point, $\phi$, is~\cite{Plonsey1963}
\begin{equation}
\label{eqn:bsp:infinite}
\phi = \frac{1}{4 \pi \sigma} \int \frac{- \nabla \cdot
\mathbf{J}^{i} }{r} dv
\end{equation}
where $r$ is the (scalar) distance from the elemental volume $dv$ to the point at
which the field is being evaluated.

To account for the influence of the finite dimensions of the torso we can use
either a FEM or a BEM (See Chapter XXXX for a discussion
of the history of the two methods).
The derivation for the BEM method is based on Green's
Theorem~\cite{Barr1966,Gulranji1980,Clayton2002},
which states that for a volume, $V$, bounded by a surface, $S$, that
\begin{equation}
\label{eqn:bsp:green}
\int_{V} \left(\phi \nabla^{2}\psi - \psi \nabla^{2}\phi  \right) dv =
\int_{S} \left( \phi \nabla \psi - \psi \nabla \phi \right) \cdot d\mathbf{S}
\end{equation}
where $\phi$ and $\psi$ are scalar functions of position.
If $\phi$ is the electrical potential and $\psi$ is set as $\frac{1}{r}$ where
$r$ is $|\mathbf{r'}-\mathbf{r}|$.
Here, $\mathbf{r'}$ is a vector to an arbitrary point in the volume $V$ at which
we wish to evaluate the field and $\mathbf{r}$ is a vector to an elemental
volume, $dv$, somewhere within the volume $V$.
Using (\ref{eqn:bsp:poisson}) we have
\begin{equation}
\label{eqn:bsp:greenandpoisson}
\int_{V}
    \left(
        \phi \nabla^{2}\left(\frac{1}{r}\right) -
        \frac{1}{r} \nabla^{2}\frac{\left(\nabla \cdot \mathbf{J}^{i} \right)}{\sigma}
    \right)
dv =
\int_{S}
    \left(
        \phi \nabla \left(\frac{1}{r}\right) -
        \left(\frac{1}{r}\right) \nabla \phi
    \right)
\cdot d\mathbf{S}
\end{equation}

The del operator in (\ref{eqn:bsp:greenandpoisson}) operates on the unprimed (source) coordinates.
Now,
\begin{equation}
\label{eqn:bsp:oneoverr}
\nabla^{2}\left(\frac{1}{r}\right) =
\nabla^{2}\left(\frac{1}{|\mathbf{r'}-\mathbf{r}|}\right) =
-4\pi\delta\left(\mathbf{r'}-\mathbf{r}\right)
\end{equation}
where $\delta$ represents the dirac delta function.  The surface $S$ is the body
surface and so on $S$, $\nabla\phi \cdot d\mathbf{S} = 0$ to a very good
approximation.  (\ref{eqn:bsp:greenandpoisson}) becomes, after substitution and
rearrangement,
\begin{equation}
\label{eqn:bsp:substituted}
\phi\left(\mathbf{r'}\right) =
\frac{1}{4 \pi \sigma}\int_{V} \frac{-\nabla \cdot \mathbf{J}^{i}}{r}dv - 
\frac{1}{4 \pi}\int_{S} \phi\left(\mathbf{r}\right)
\nabla\left(\frac{1}{r}\right) \cdot d\mathbf{S}
\end{equation}

By noting that
\begin{equation}
\label{eqn:bsp:solidanglesubs}
\nabla\left(\frac{1}{r}\right) \cdot d\mathbf{S} =
\frac{\left(\mathbf{r'}-\mathbf{r}\right)}{|\mathbf{r'}-\mathbf{r}|^{3}} \cdot d\mathbf{S} =
d\Omega
\end{equation}
where $d\Omega$ is a differential element of solid angle,
(\ref{eqn:bsp:substituted}) becomes
\begin{equation}
\label{eqn:bsp:substitutedomega}
\phi\left(\mathbf{r'}\right) =
\frac{1}{4 \pi \sigma}\int_{V} \frac{-\nabla \cdot \mathbf{J}^{i}}{r}dv -
\frac{1}{4 \pi}\int_{S} \phi\left(\mathbf{r}\right)d\Omega
\end{equation}
The first term on the right hand side can be recognised as the infinite medium
potential (\ref{eqn:bsp:infinite}) and the second term consists of contributions
from the torso surface.
To discretise (\ref{eqn:bsp:substitutedomega}) we can consider $S$ to be made up of
$n$ triangles, leading to
\begin{equation}
\label{eqn:bsp:discrete}
\phi\left(\mathbf{r'}\right) \approx
\frac{1}{4 \pi \sigma}\int_{V} \frac{-\nabla \cdot \mathbf{J}^{i}}{r}dv -
\frac{1}{4 \pi}\sum_{j=1}^n \phi_{j}\Delta\Omega_{j}
\end{equation}
where $\phi_{j}$ is the potential on the j\textsuperscript{th}\ surface element
and $\Delta\Omega_{j}$ is the increment of solid angle of the
j\textsuperscript{th}\ element when viewed from $\mathbf{r'}$.
To find a solution, Barr et al. noted that $\phi\left(\mathbf{r'}\right)$ is the
potential at an arbitrary point inside $V$.
If these points are chosen to be at the centres of the triangles just inside
the surface $S$ then since $\nabla\phi \cdot d\mathbf{S} = 0$ we can get an
expression for the potential on the i\textsuperscript{th}\ triangle, $\phi_{i}$,
\begin{equation}
\label{eqn:bsp:discretei}
\phi_{i} =
\frac{1}{4 \pi \sigma}\int_{V} \frac{-\nabla \cdot \mathbf{J}^{i}}{r}dv -
\frac{1}{4 \pi}\sum_{j=1}^n \phi_{j}\Delta\Omega_{ij}
\end{equation}
where $\Delta\Omega_{ij}$ is the solid angle of the j\textsuperscript{th}\
triangle seen from the i\textsuperscript{th}\ triangle.
In the summation in (\ref{eqn:bsp:discretei}) there is one term which corresponds to
the case where $i = j$.
In this case, $\Delta\Omega_{ii} = -2\pi$ as from a point just inside $i$, $i$
will obscure an angle of $-2\pi$.  (As a consequence of the vector definition of
solid angle, the solid angle obscured at any point within is negative)
Equation (\ref{eqn:bsp:discretei}) then becomes, after rearrangement,
\begin{equation}
\label{eqn:bsp:discretefinal}
\frac{\phi_{i}}{2} + \sum_{j=1,j \neq i}^n \left(\frac{\Delta\Omega_{ij}}{4\pi} \right)\phi_{j} =
\frac{1}{4 \pi \sigma}\int_{V} \frac{-\nabla \cdot \mathbf{J}^{i}}{r}dv
\end{equation}
which represents a set of $n$ simultaneous equations for the potentials on the
surface elements of the torso.
Using an alternate formulation of (\ref{eqn:bsp:infinite})~\cite{Plonsey1989} in
which $\mathbf{J}^i$ can be considered a dipole density
\begin{equation}
\label{eqn:bsp:b}
B_i = \frac{1}{4 \pi \sigma}\int_{V} \frac{\mathbf{J}^{i}\cdot
\left(\mathbf{r'}-\mathbf{r}\right)}{r^3}dv
\end{equation}
equation (\label{eqn:bsp:discretefinal}) can be written in matrix form as
\begin{equation}
\label{eqn:bsp:matrix}
\mathbf{A}\mathbf{\phi} = \mathbf{B}
\end{equation}
where $\mathbf{A}$ is a matrix which depends entirely on the geometry of the
torso surface with a typical term of $\displaystyle A_ij =
-\frac{\Delta\Omega_ji}{4\pi}$ and $A_ii = 0.5$, $\mathbf{\phi}$ is a column
vector of the potentials of the $n$ triangles and $\mathbf{B}$ is a column
vector of the infinite medium potentials at the centres of the triangles of the
surface.
Equation (\ref{eqn:bsp:matrix}) can be extended to allow for multiple
inhomogeneities, derivations for which can be found
in~\cite{Barr1966,Geselowitz1968,Geselowitz1970}.
Studies by Klepfer et al.~\ref{Klepfer1997}\ and Ramanathan and
Rudy~\ref{Ramanathan2001}\ suggest that including such inhomogeneous regions has
an influence on the magnitudes of the components of the body surface potential
and ECG but little influence on their shape.
For this reason, a homogeneous torso model was used.

If the surface $S$ was discretised with sufficient accuracy then $\mathbf{A}$
will necessarily be singular, due to the physical nature of the problem.
This was noted by Salu~\ref{Salu1980}\ who proposed a solution which takes
advantage of the physical properties of the system (an alternative method of
removing the singularity of the system was proposed by Lynn and Timlake, the
deflation method).
Salu noted that, experimentally, the potential $\phi$ can only be determined up to
an additive constant.
Therefore $\phi$ can be taken as $0$ at arbitrarily chosen point, without
effecting the general solution.
Assigning $\phi_1 = 0$ in (\ref{eqn:bsp:matrix}) leads to
\begin{equation}
\label{eqn:bsp:salufirst}
\sum_{j=2}^n A_ij \phi_j = B_i \quad\quad  i = 1,\cdots, n
\end{equation}
which is a set of $n$ equations in $n-1$ unknowns.
These equations should have exactly one solution.
If an exact solution exists, this implies two things: (a)
(\ref{eqn:bsp:salufirst}) is a set of $n$ consistent equations in $n-1$ unknowns
and (b) the rank of the sub-matrix $A_ij: i=2,\cdots,n j=2,\cdots,n$ is $n-1$.
Hence there are $n$ nontrivial $\lambda_i$ such that the rows of $\textbf{A}$
fulfil
\begin{equation}
\label{eqn:bsp:salulambda}
\sum_{i=1}^n \lambda_i A_ij  = 0 \quad\quad  j = 2,\cdots, n
\end{equation}
The $\lambda_i$s may be determined up to a proportional factor.
For (\ref{eqn:bsp:matrix}) to be consistent, it is also required that
\begin{equation}
\label{eqn:bsp:salulambdaB}
\sum_{i=1}^n \lambda_i B_i  = 0
\end{equation}
Salu notes that (\ref{eqn:bsp:salulambdaB}) might not hold for a number of
reasons, including numerical inaccuracies in the discretisation of surface or
errors in the calculation of the $B_i$s.
This would lead to a difference between $\phi_{\text{calculated}}$ and
$\phi_{\text{real}}$.
Considering once more the physical properties of the system, $B_i$ as an
electrostatic potential could only be determined up to some additive constant,
$\alpha$.
Equation (\ref{eqn:bsp:salulambda}) then becomes
\begin{equation}
\label{eqn:bsp:salulambdaalpha}
\sum_{i=1}^n \lambda_i \left(B_i+\alpha\right)  = 0
\end{equation}

This can be incorporated into (\ref{eqn:bsp:salufirst}) to get a set of $n$
equations
\begin{equation}
\label{eqn:bsp:salufinal}
\sum_{j=2}^n A_ij \phi_j = B_i + \alpha \quad\quad  i = 1,\cdots, n
\end{equation}
Equation (\ref{eqn:bsp:salufinal}) is now numerically consistent and is
equivalent to (\ref{eqn:bsp:matrix}).
Whenever (\ref{eqn:bsp:salulambdaB}) is not fulfilled, due to numerical errors
in the discritisation and creation of $\textbf{A}$ or in the calculation of
$\textbf{B}$, the addition of the $\alpha$ term ensures that
(\ref{eqn:bsp:salufinal}) has a consistent solution.
It is important to note that consistent does not mean necessarily mean accurate
or correct.
The addition of the $\alpha$ term merely ensures that a solution will exist.
Due care must still be taken with the construction of each $A_ij$ term and
accuracy can be improved via choosing a finer discretisation for the body
surface mesh.

An efficient solution to the problem of solving the equations and for $\alpha$
was given by Salu.
To do this, we let $\phi_j^* \left(j=2,\cdots,n\right)$ be a solution to the
$n-1$ equations
\begin{equation}
\label{eqn:bsp:saluphijstar}
\sum_{j=2}^n A_ij \phi_j^* = B_i \quad\quad  i = 2,\cdots, n
\end{equation}
and let $\phi_j^1 \left(j=2,\cdots,n\right)$ be a solution to the $n-1$
equations
\begin{equation}
\label{eqn:bsp:saluphijone}
\sum_{j=2}^n A_ij \phi_j^1 = 1 \quad\quad  i = 2,\cdots, n
\end{equation}
where the $1$ represents a column vector of 1s.
The two vectors $\phi_j^*$ and $\phi_j^1$ both multiply the same matrix,
$\mathbf{A}$ so it need only be inverted once to solve both
(\ref{eqn:bsp:saluphijstar}) and (\ref{eqn:bsp:saluphijone}).
Letting $\phi_j \left(j=2,\cdots,n\right)$ be a solution to the set of $n-1$
equations
\begin{equation}
\label{eqn:bsp:saluphij}
\sum_{j=2}^n A_ij \phi_j = B_i + \alpha \quad\quad  i = 2,\cdots, n
\end{equation}
where $\alpha$ is the same alpha introduced in (\ref{eqn:bsp:salulambdaalpha}).
From equations (\ref{eqn:bsp:saluphijstar})--(\ref{eqn:bsp:saluphij}), the
solution to the set of equations will be
\begin{eqnarray}
\label{eqn:bsp:salusolution}
\phi_j&=&\phi_j^* + \alpha\phi_j^1 \quad\quad  j = 2,\cdots, n \nonumber\\
\phi_1&=&0
\end{eqnarray}

Substituting (\ref{eqn:bsp:salusolution}) into the first equation of
(\ref{eqn:bsp:salufinal}) will give
\begin{equation}
\label{eqn:bsp:salualphastep1}
\sum_{j=2}^n A_1j \left(\phi_j^* + \alpha\phi_j^1\right) = B_i + \alpha
\end{equation}
or after re-arranging to solve for $\alpha$
\begin{equation}
\label{eqn:bsp:salualphastep2}
\alpha = 
    \frac{
        \left(\sum_{j=2}^n A_1j \phi_j^*\right)-B_i
        }{
        1-eft(\sum_{j=2}^n A_1j \phi_j^1
        }
\end{equation}
Equation (\ref{eqn:bsp:salualphastep2}) can be used along with
(\ref{eqn:bsp:saluphijstar})--(\ref{eqn:bsp:saluphij}) to solve
(\ref{eqn:bsp:matrix}) to find the body surface potential.

\section{The Atrial Dipole}

In the previous section, the method for solving Maxwell's equations to determine
the body surface potential was derived.
The $\mathbf{B}$ term in the Equation (\ref{eqn:bsp:matrix}) is the infinite
homogeneous medium potential for a number of impressed current sources
$\mathbf{J}^i$.
The model of atrial electrophysiological activity developed in the previous
chapter provides an output of the trans-membrane potentials, $V_m$.
To relate the values of $V_m$ to $\mathbf{J}^i$ we consider the bidomain
model~\ref{Tung,otherguy}.
As previously discussed, the bidomain model considers the cardiac tissue as
comprising two `syncytica' occupying the whole of cardiac tissue and seperated
by the cell membrane.
These are the intra- and extra-cellular spaces.
This leads to the following two relationships
\begin{align}
\label{eqn:bsp:bidomaini}
\mathbf{J}_i & = -\sigma_i \nabla \phi_i \\
\label{eqn:bsp:bidomaine}
\mathbf{J}_e & = -\sigma_e \nabla \phi_e
\end{align}
where $\mathbf{J}$ is a current density, $\sigma$ is the conductivity, $\phi$
is the potential and the subscripts `i' and `e' denote the intra- and
extra-cellular spaces, respectively.
Charge moving from one space to another must cross the cell membrane and is
conserved, leading to the following relationship for $I_m$, the membrane current per unit
volume
\begin{equation}
\label{eqn:bsp:im}
I_m = -\nabla\cdot\mathbf{J}_e = \nabla\cdot\mathbf{J}_i
\end{equation}
By definition the transmembrane potential, $V_m$ is
\begin{equation}
\label{eqn:bsp:tmp}
V_m = \phi_i - \phi_e
\end{equation}
Combining these two equations leads to
\begin{equation}
\label{eqn:bsp:poissonrep}
\nabla\cdot\sigma_i\nabla V_m = -\nabla\cdot\sigma\nabla\phi_e
\end{equation}
where $\sigma = \sigma_i + \sigma_e$, the bulk conductivity of the cardiac
tissue.
Equation (\ref{eqn:bsp:poissonrep}) is of the form of poisson's equation.
The equation can be interpreted to indicate that the term on the left hand side
is the source of the extracellular potentials.
By comparing (\ref{eqn:bsp:poissonrep}) with (\ref{eqn:bsp:poisson}) it is
obvious that
\begin{equation}
\label{eqn:bsp:ji}
$\mathbf{J}^i = -\sigma_i\nabla V_m$.
\end{equation}

\section{Torso Geometry}

The torso geometry used in this study is shown in Figure~\ref{fig:bsp:torso}.
It is based on the geometry used by Weixue and Ling~\ref{Weixue1996}\ which was
derived from CT images of the human torso.
The original geometry consisted of 412 vertices which were linked by 820
triangular elements.
The triangular elements were subdivided into 3280 triangles and 1642 vertices
using the Blender~\ref{Blender}\ 3D modelling package, but this was found to
have no discernible influence on the generated ECG.
Initial studies using a spherical geometry with a similar number of triangle and
the analytical formula for the potential within a conducting sphere suggest that
the errors~\ref{FergusonStroink1994} induced through the descritisation are less
than 0.01\%.

The atrial model constructed in the previous chapter was embedded within the
torso using the descriptions of Ho and S\'{a}nchez-Quintana~\ref{HoQuintana2008}
with the ventricles from the original torso used as a guide.
Several of the triangular elements were picked as the sites of the ECG
electrodes.
The complete torso model with the embedded atrium and electrode locations is
shown in Figure~\ref{fig:bsp:torsoatrium}.

\section{Computational Implementation}

The program which solved the equations and generated the potentials at each of
the elements of the geometry was written in the Fortran 95 programming language.
The $\mathbf{A}$ matrix from (\ref{eqn:bsp:matrix}) was constructed using the
method proposed by van Oosterom and Strackee~\ref{OosteromStrackee1983}\ to
estimate the solid angle subtended by each triangular element.
A subroutine written in C was used to read in the gzip or xz compressed
data files corresponding to each snapshot in time (\ms{1}) generated by the
atrial model.
The impressed current density at each node of the tissue was calculated using
(\ref{eqn:bsp:ji}).
To reduce computational time and memory requirements, the atrial geometry was
divided into 10x10x10 node blocks, around 4000 of which actually had active
nodes within.
The dipoles generated by each active node were aggregated and considered to act
at the centroid of the block determined from the distribution of active nodes
within the block.
These `large' dipoles were then used as the source terms in
(\ref{eqn:bsp:infinite}).
Decreasing the block size to 5x5x5 nodes had a negligible effect on the computed
body surface potential.
A uniform conductance of $0.2\,\Omega \text{m}^{-1}$~\ref{ClaytonHolden2002,Seger2004} was assumed for the torso.
From these dipoles, the $\mathbf{B}$ was calculated.

To solve the resulting set of equations, the LAPACK~\ref{lapack} library was
used.
The $\mathbf{A}$ matrix was factorized using the DGETRF sub-routine.
Since the torso is static this need only be done once, at the start of the
calculations.
The DGETRS sub-routine was then used to solve (\ref{eqn:bsp:saluphijone}) and
(\ref{eqn:bsp:saluphijstar}) for each time snapshot using this factorised
matrix.
Generating the body surface potential took one core of horace approximately 70
minutes for \unit{2}{s}\ of atrial activity.

\section{Simulating the Normal Atrial Depolarisation}

Using the 3D atrial model developed in the previous chapter with full fibre
orientation description, an anisotropy ratio of 1:9, heterogeneous cell
electrophysiology and paced at the sinus node with a frequency of \unit{2}{Hz}\
the body surface potential and associated ECGs were generated for sinus rhythm.

